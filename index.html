<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DNS Checker</title>
<style>
  html, body { min-height: 560px; }
  body { font-family: system-ui, sans-serif; margin: 20px; background: #f9f9f9; color: #333; }
  h2 { margin-top: 0; text-align:center; }
  .banner { padding: 12px; margin: 16px auto; max-width: 900px; font-weight: 700; border-radius: 6px; text-align:center; }
  .banner.ok { background: #e6ffed; color: #067d21; }
  .banner.fail { background: #ffecec; color: #a10000; }
  table { border-collapse: collapse; width: 900px; max-width: 100%; margin: 0 auto; background: #fff; }
  th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
  th { background: #f0f0f0; }
  .ok { color: #0a8f3a; font-weight: 700; }
  .fail { color: #c40000; font-weight: 700; }
</style>
</head>
<body>
  <h2 id="host">DNS Record Verification</h2>
  <div id="banner" class="banner">Checking…</div>
  <table>
    <thead>
      <tr>
        <th>DNS Record</th>
        <th colspan="2">Expected</th>
        <th colspan="2">Actual</th>
      </tr>
      <tr>
        <th>Type</th><th>Value</th><th>Data</th><th>Value</th><th>Data</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

<script>
(async () => {
  const qs = new URLSearchParams(location.search);
  const domain    = (qs.get('domain') || '').trim();
  const expectedA = (qs.get('expectedA') || qs.get('arec') || '').split(',').map(s => s.trim()).filter(Boolean);
  const expectedC = (qs.get('expectedC') || qs.get('cname') || '').trim();
  const cnameHost = (qs.get('cnameHost') || 'www').trim() || 'www';
  const debug     = qs.get('debug') === '1';

  document.getElementById('host').textContent = domain || 'DNS Record Verification';

  const canon = s => String(s || '').trim().replace(/\.$/, '').toLowerCase();

  async function doh(name, type) {
    const urls = [
      `https://cloudflare-dns.com/dns-query?ct=application/dns-json&name=${encodeURIComponent(name)}&type=${encodeURIComponent(type)}`,
      `https://dns.google/resolve?name=${encodeURIComponent(name)}&type=${encodeURIComponent(type)}`
    ];
    let lastErr;
    for (const url of urls) {
      try {
        const headers = url.includes('cloudflare-dns.com') ? { accept:'application/dns-json' } : {};
        const r = await fetch(url, {
          mode:'cors',
          headers,
          cache:'no-store',
          referrerPolicy:'no-referrer',
          credentials:'omit'
        });
        if (!r.ok) throw new Error(`HTTP ${r.status} from ${url}`);
        const j = await r.json();
        return (j.Answer || []).map(a => a.data);
      } catch (e) { lastErr = e; }
    }
    throw lastErr || new Error('All DoH providers failed');
  }

  const rows = document.getElementById('rows');
  const banner = document.getElementById('banner');

  const addRow = (type, expVal, expData, actVal, actData, match) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${type}</td>
      <td>${expVal}</td>
      <td>${expData || '-'}</td>
      <td>${actVal}</td>
      <td>${Array.isArray(actData) ? actData.join(', ') : (actData || '-')}
        ${match === null ? '' : (match ? '<span class="ok"> ✔</span>' : '<span class="fail"> ✘</span>')}
      </td>`;
    rows.appendChild(tr);
  };

  try {
    // A record check
    const liveA = (await doh(domain,'A')).filter(v => /^\d+\.\d+\.\d+\.\d+$/.test(v));
    const aMatch = expectedA.length ? expectedA.every(ip => liveA.includes(ip)) : null;
    addRow('A', '@', expectedA.join(', ') || '-', '@', liveA, aMatch);

    // CNAME check
    const host = (cnameHost === '@' ? domain : `${cnameHost}.${domain}`);
    let liveC = (await doh(host,'CNAME')).map(canon);
    let cMatch = expectedC ? liveC.includes(canon(expectedC)) : null;

    // flatten tolerance: no CNAME but A(host)==A(expectedC)
    if (expectedC && cMatch === false && liveC.length === 0) {
      const hostA = (await doh(host,'A')).filter(v => /^\d+\.\d+\.\d+\.\d+$/.test(v));
      const expectedCA = (await doh(expectedC,'A')).filter(v => /^\d+\.\d+\.\d+\.\d+$/.test(v));
      if (hostA.length && expectedCA.length && expectedCA.every(ip => hostA.includes(ip))) cMatch = true;
    }
    addRow('CNAME', cnameHost, expectedC || '-', cnameHost, liveC, cMatch);

    // Overall banner
    const checks = [aMatch, cMatch].filter(v => v !== null);
    const ok = checks.length ? checks.every(Boolean) : false;
    banner.className = 'banner ' + (ok ? 'ok' : 'fail');
    banner.textContent = ok ? "Your DNS Records are correct" : "Your DNS Records are not correct";

    if (debug) console.log({domain, expectedA, expectedC, cnameHost, liveA, liveC, aMatch, cMatch, ok});
  } catch (e) {
    banner.className = 'banner fail';
    banner.innerHTML = 'Could not fetch DNS records on this device.<br>' +
      '<small>(iOS Safari sometimes blocks third-party requests inside iframes.)</small><br>' +
      '<a href="' + location.href + '" target="_blank" rel="noopener">Open checker in a new tab</a>';
    console.error('DoH error:', e);
  }
})();
</script>
</body>
</html>

