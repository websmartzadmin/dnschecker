<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DNS Check → Redirect</title>
<style>
  html,body{margin:0;font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:720px;margin:12vh auto;padding:16px;text-align:center}
  .spinner{width:36px;height:36px;border:4px solid #eee;border-top-color:#555;border-radius:50%;margin:16px auto;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}} .small{color:#666;font-size:12px;margin-top:8px}
</style>
</head>
<body>
<div class="wrap">
  <h2>Checking your DNS…</h2>
  <div class="spinner" aria-hidden="true"></div>
  <div id="msg" class="small">Please wait, redirecting to the form.</div>
</div>

<script>
(async () => {
  const qs = new URLSearchParams(location.search);
  const debug = qs.get('debug') === '1';
  const setMsg = t => { const el=document.getElementById('msg'); if (el) el.textContent=t; };
  const canon = s => String(s||'').trim().replace(/\.$/,'').toLowerCase();

  // Inputs
  let jotform = (qs.get('jotform') || '').trim();
  const jotform64 = qs.get('jotform64');
  const domain = (qs.get('domain') || '').trim();
  const expectedA = (qs.get('expectedA') || '').split(',').map(s=>s.trim()).filter(Boolean);
  const expectedC = (qs.get('expectedC') || '').trim();
  const cnameHost = (qs.get('cnameHost') || 'www').trim() || 'www';

  // Optional: checker passed separately to the redirector
  let checkerParam = qs.get('dnscheckurl');         // should be single-encoded
  let checkerRaw   = qs.get('dnscheckurl_raw');     // decoded / human-readable
  let checker64    = qs.get('dnscheckurl64');       // base64

  // Support base64 for jotform if used
  if (!jotform && jotform64) {
    try { jotform = decodeURIComponent(escape(atob(jotform64))); }
    catch { try { jotform = atob(jotform64); } catch {} }
  }
  if (!jotform) { setMsg('Missing ?jotform= (encoded JotForm URL)'); return; }
  if (!domain || (!expectedA.length && !expectedC)) { setMsg('Missing DNS params: need domain and expectedA and/or expectedC'); return; }

  // DNS-over-HTTPS
  async function doh(name, type) {
    const urls = [
      `https://cloudflare-dns.com/dns-query?ct=application/dns-json&name=${encodeURIComponent(name)}&type=${encodeURIComponent(type)}`,
      `https://dns.google/resolve?name=${encodeURIComponent(name)}&type=${encodeURIComponent(type)}`
    ];
    let lastErr;
    for (const url of urls) {
      try {
        const headers = url.includes('cloudflare-dns.com') ? { accept:'application/dns-json' } : {};
        const r = await fetch(url, { mode:'cors', headers });
        if (!r.ok) throw new Error(`HTTP ${r.status} from ${new URL(url).hostname}`);
        const j = await r.json();
        return (j.Answer || []).map(a => a.data);
      } catch (e) { lastErr = e; }
    }
    throw lastErr || new Error('All DoH providers failed');
  }

  // Run DNS check
  let ok = false;
  try {
    const liveA = (await doh(domain,'A')).filter(v => /^\d+\.\d+\.\d+\.\d+$/.test(v));
    const fqdn = (cnameHost === '@' ? domain : `${cnameHost}.${domain}`);
    let liveC = (await doh(fqdn,'CNAME')).map(canon);

    const aMatch = expectedA.length ? expectedA.every(ip => liveA.includes(ip)) : null;
    let cMatch = expectedC ? liveC.includes(canon(expectedC)) : null;

    // Optional: treat flattened CNAME as match
    if (expectedC && cMatch === false && liveC.length === 0) {
      const hostA = (await doh(fqdn,'A')).filter(v => /^\d+\.\d+\.\d+\.\d+$/.test(v));
      const expectedCA = (await doh(expectedC,'A')).filter(v => /^\d+\.\d+\.\d+\.\d+$/.test(v));
      if (hostA.length && expectedCA.length && expectedCA.every(ip => hostA.includes(ip))) cMatch = true;
    }

    const checks = [aMatch, cMatch].filter(v=>v!==null);
    ok = checks.length ? checks.every(Boolean) : false;

    if (debug) console.log({domain, expectedA, expectedC, cnameHost, liveA, liveC, aMatch, cMatch, ok});
  } catch(e) {
    ok = false;
    if (debug) console.error(e);
  }

  // Decode jotform (expected to be single-encoded)
  try { jotform = decodeURIComponent(jotform); } catch {}
  let target; try { target = new URL(jotform); } catch { setMsg('Invalid JotForm URL'); return; }

  // Always append dnsvalid
  target.searchParams.set('dnsvalid', ok ? 'yes' : 'no');

  // --- Build/normalize dnscheckurl for the final JotForm URL ---
  (function ensureDnsCheckUrl(){
    // Prefer caller-provided checker (dnscheckurl64 > dnscheckurl_raw > dnscheckurl)
    let decodedChecker = '';
    if (checker64) {
      try { decodedChecker = decodeURIComponent(escape(atob(checker64))); }
      catch { try { decodedChecker = atob(checker64); } catch {} }
    } else if (checkerRaw) {
      decodedChecker = checkerRaw;
    } else if (checkerParam) {
      // heal double-encoding (e.g., %253A → %3A)
      decodedChecker = /%25[0-9A-Fa-f]{2}/.test(checkerParam) ? (function(s){ try { return decodeURIComponent(s); } catch { return s; } })(checkerParam) : checkerParam;
      // if still encoded, decode for inspection
      if (/^https%3A%2F%2F/i.test(decodedChecker)) { try { decodedChecker = decodeURIComponent(decodedChecker); } catch {} }
    }

    // If none provided or missing key params, build from authoritative values
    const needsBuild = !decodedChecker || !/[?&](expectedA|expectedC|cnameHost)=/i.test(decodedChecker);
    if (needsBuild) {
      const rowid = target.searchParams.get('rowid') || target.searchParams.get('cb') || '';
      const cb = rowid || String(Date.now());
      let built = `https://websmartzadmin.github.io/dnschecker?domain=${encodeURIComponent(domain)}`;
      if (expectedA.length) built += `&expectedA=${encodeURIComponent(expectedA.join(','))}`;
      if (expectedC)        built += `&expectedC=${encodeURIComponent(expectedC)}`;
      built += `&cnameHost=${encodeURIComponent(cnameHost)}&cb=${encodeURIComponent(cb)}`;
      decodedChecker = built;
    }

    // Re-encode once for nesting in JotForm
    const encodedOnce = encodeURIComponent(decodedChecker);
    target.searchParams.set('dnscheckurl', encodedOnce);
  })();

  setMsg(ok ? 'DNS valid — redirecting…' : 'DNS not valid — redirecting…');
  location.replace(target.toString());
})();
</script>
</body>
</html>









