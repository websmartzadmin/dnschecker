<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DNS Checker Widget</title>
<!-- Jotform Widget SDK (needed if this is used as a true custom widget) -->
<script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
<style>
  html, body { margin:0; background:transparent; font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial; color:#111; }
  h2 { text-align:center; margin:10px 0; }
  .wrap { padding:12px; }
  .status { padding:10px; font-weight:700; color:#fff; text-align:center; border-radius:6px; margin-bottom:12px; }
  .ok { background:#16a34a; } 
  .bad { background:#dc2626; }
  table{width:100%;border-collapse:collapse;border:1px solid #ddd}
  th,td{border:1px solid #ddd;padding:8px;text-align:center}
  thead th{background:#f6f6f6}
  .cell-ok{color:#16a34a;font-weight:700}
  .cell-bad{color:#dc2626;font-weight:700}
  .hint{color:#555;font-size:12px;margin-top:8px}
</style>
</head>
<body>
<div class="wrap">
  <h2 id="title">DNS Check</h2>
  <div id="banner" class="status">Checking…</div>
  <table>
    <thead>
      <tr>
        <th rowspan="2">DNS Record</th>
        <th colspan="2">Expected</th>
        <th colspan="2">Actual</th>
      </tr>
      <tr>
        <th>Value</th><th>Data</th>
        <th>Value</th><th>Data</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>A</td>
        <td>@</td>
        <td id="expA">—</td>
        <td>@</td>
        <td id="actA">—</td>
      </tr>
      <tr>
        <td>CNAME</td>
        <td id="cnameVal">www</td>
        <td id="expC">—</td>
        <td id="actCVal">www</td>
        <td id="actC">—</td>
      </tr>
    </tbody>
  </table>
  <div id="hint" class="hint"></div>
</div>

<script>
(async () => {
  const qs = new URLSearchParams(location.search);
  const debug = qs.get('debug') === '1';

  const domain    = (qs.get('domain') || '').trim();
  const expectedA = (qs.get('expectedA') || '').split(',').map(s => s.trim()).filter(Boolean);
  const expectedC = (qs.get('expectedC') || '').trim();
  const cnameHost = (qs.get('cnameHost') || 'www').trim() || 'www';

  const $ = id => document.getElementById(id);
  const canon = s => String(s || '').trim().replace(/\.$/, '').toLowerCase();

  $('title').textContent = domain || 'DNS Check';
  $('expA').textContent = expectedA.join(', ') || '—';
  $('expC').textContent = expectedC || '—';
  $('cnameVal').textContent = cnameHost === '@' ? '@' : cnameHost;
  $('actCVal').textContent  = cnameHost === '@' ? '@' : cnameHost;

  function setBanner(ok, text) {
    const b = $('banner');
    b.className = 'status ' + (ok ? 'ok' : 'bad');
    b.textContent = text;
  }
  function addOK(id){ const el=$(id); el.classList.remove('cell-bad'); el.classList.add('cell-ok'); }
  function addBAD(id){ const el=$(id); el.classList.remove('cell-ok'); el.classList.add('cell-bad'); }

  // DNS-over-HTTPS with CF -> Google fallback
  async function doh(name, type) {
    const urls = [
      `https://cloudflare-dns.com/dns-query?ct=application/dns-json&name=${encodeURIComponent(name)}&type=${encodeURIComponent(type)}`,
      `https://dns.google/resolve?name=${encodeURIComponent(name)}&type=${encodeURIComponent(type)}`
    ];
    let lastErr;
    for (const url of urls) {
      try {
        const headers = url.includes('cloudflare-dns.com') ? { 'accept':'application/dns-json' } : {};
        const r = await fetch(url, { mode:'cors', headers });
        if (!r.ok) throw new Error(`HTTP ${r.status} from ${new URL(url).hostname}`);
        const j = await r.json();
        if (debug) console.log({ provider:new URL(url).hostname, name, type, j });
        return (j.Answer || []).map(a => a.data);
      } catch (e) { lastErr = e; if (debug) console.warn('DoH failed →', e.message || e); }
    }
    throw lastErr || new Error('All DoH providers failed');
  }

  // Guard to prevent false error banner after success
  let comparisonDone = false;

  if (!domain || (!expectedA.length && !expectedC)) {
    setBanner(false, 'Missing parameters: domain and expectedA/expectedC');
    $('hint').textContent = 'Example: ?domain=example.com&expectedA=93.184.216.34&expectedC=pages.host.com&cnameHost=www';
    return;
  }

  try {
    // === Fetch DNS ===
    const liveA = (await doh(domain, 'A')).filter(v => /^\d+\.\d+\.\d+\.\d+$/.test(v));
    $('actA').textContent = liveA.join(', ') || '—';

    const fqdn = (cnameHost === '@' ? domain : `${cnameHost}.${domain}`);
    let liveC = (await doh(fqdn, 'CNAME')).map(canon);
    if (liveC.length === 0) {
      const flattenedA = (await doh(fqdn, 'A')).filter(v => /^\d+\.\d+\.\d+\.\d+$/.test(v));
      $('actC').textContent = flattenedA.length ? `${flattenedA.join(', ')} (A)` : '—';
    } else {
      $('actC').textContent = liveC.join(', ') || '—';
    }

    // === Compare ===
    const aMatch = expectedA.length ? expectedA.every(ip => liveA.includes(ip)) : null;
    const cMatch = expectedC ? liveC.includes(canon(expectedC)) : null;

    if (aMatch !== null) { aMatch ? (addOK('expA'), addOK('actA')) : addBAD('actA'); }
    if (cMatch !== null) { cMatch ? (addOK('expC'), addOK('actC')) : addBAD('actC'); }

    const checks = [aMatch, cMatch].filter(v => v !== null);
    const ok = checks.length ? checks.every(Boolean) : false;

    setBanner(ok, ok ? "Your DNS Records are correct" : "Your DNS Records are NOT correct");

    const hints = [];
    if (aMatch === false) hints.push(`A mismatch: expected ${expectedA.join(', ')} vs actual ${liveA.join(', ') || '—'}.`);
    if (cMatch === false) {
      const actCtxt = $('actC').textContent || '—';
      hints.push(`CNAME mismatch on ${cnameHost === '@' ? 'root (@)' : cnameHost}: expected ${expectedC} vs actual ${actCtxt}.`);
      hints.push(`Note: some providers flatten CNAME to A; then CNAME appears empty and A shows instead.`);
    }
    $('hint').innerHTML = hints.join(' ');

    comparisonDone = true;

    // === Jotform widget integration (safe) ===
    if (window.JFCustomWidget) {
      try {
        JFCustomWidget.setValue(JSON.stringify({ ok, aMatch, cMatch, observedA: liveA, observedC: liveC, cnameHostUsed: cnameHost, domain }));
        JFCustomWidget.subscribe('submit', function(){
          JFCustomWidget.sendSubmit(!!ok, ok ? undefined : { error: "DNS check failed" });
        });
        if (JFCustomWidget.requestFrameResize) {
          JFCustomWidget.requestFrameResize({ height: document.body.scrollHeight });
        }
      } catch (e) {
        if (debug) console.warn('Widget plumbing error (ignored):', e);
      }
    }

  } catch (e) {
    if (!comparisonDone) {
      setBanner(false, "Could not fetch DNS records");
      $('hint').textContent = (e && e.message) ? e.message : String(e);
    }
    if (debug) console.error(e);
    if (window.JFCustomWidget) {
      try {
        JFCustomWidget.setValue(JSON.stringify({ ok:false, error:'doh_failed', message: String(e && e.message || e) }));
        JFCustomWidget.subscribe('submit', function(){ JFCustomWidget.sendSubmit(false, { error: "DNS lookup failed" }); });
      } catch(_) {}
    }
  }
})();
</script>
</body>
</html>

    if (aMatch !== null) { aMatch ? (addOK('expA'), addOK('actA')) : addBAD('actA'); }
    if (cMatch !== null) { cMatch ? (addOK('expC'), addOK('actC')) : addBAD('actC'); }

    const checks = [aMatch, cMatch].filter(v => v !== null);
    const ok = checks.length ? checks.every(Boolean) : false;

    setBanner(ok, ok ? "Your DNS Records are correct" : "Your DNS Records are NOT correct");

    const hints = [];
    if (aMatch === false) hints.push(`A mismatch: expected ${expectedA.join(', ')} vs actual ${liveA.join(', ') || '—'}.`);
    if (cMatch === false) {
      const actCtxt = $('actC').textContent || '—';
      hints.push(`CNAME mismatch on ${cnameHost === '@' ? 'root (@)' : cnameHost}: expected ${expectedC} vs actual ${actCtxt}.`);
      hints.push(`Note: some providers flatten CNAME to A; then CNAME appears empty and A shows instead.`);
    }
    $('hint').innerHTML = hints.join(' ');

    comparisonDone = true;

    // 4) Jotform widget plumbing (never throw)
    if (window.JFCustomWidget) {
      try {
        JFCustomWidget.setValue(JSON.stringify({ ok, aMatch, cMatch, observedA: liveA, observedC: liveC, cnameHostUsed: cnameHost, domain }));
        JFCustomWidget.subscribe('submit', function(){
          JFCustomWidget.sendSubmit(!!ok, ok ? undefined : { error: "DNS check failed" });
        });
        if (JFCustomWidget.requestFrameResize) {
          JFCustomWidget.requestFrameResize({ height: document.body.scrollHeight });
        }
      } catch (e) {
        if (debug) console.warn('Widget plumbing error (ignored):', e);
      }
    }

  } catch (e) {
    // Only show the red banner if we *haven't* already completed successfully
    if (!comparisonDone) {
      setBanner(false, "Could not fetch DNS records");
      $('hint').textContent = (e && e.message) ? e.message : String(e);
    }
    if (debug) console.error(e);
    if (window.JFCustomWidget) {
      try {
        JFCustomWidget.setValue(JSON.stringify({ ok:false, error:'doh_failed', message: String(e && e.message || e) }));
        JFCustomWidget.subscribe('submit', function(){ JFCustomWidget.sendSubmit(false, { error: "DNS lookup failed" }); });
      } catch(_) {}
    }
  }
})();
</script>
    <h2 id="domain">DNS Record Confirmation</h2>

    <table>
      <thead>
        <tr>
@@ -87,7 +67,9 @@ <h2 id="domain">DNS Record Confirmation</h2>
        </tr>
      </tbody>
    </table>

    <div id="status" class="status">Checking DNS…</div>
    <div id="details" class="details hide"></div>
  </div>

  <script>
@@ -104,37 +86,60 @@ <h2 id="domain">DNS Record Confirmation</h2>
    document.getElementById('cnameHostCell').textContent = cnameHost;
    document.getElementById('actCnameHost').textContent  = cnameHost;

    /* --- Cloudflare DNS over HTTPS --- */
    /* --- Cloudflare DNS-over-HTTPS --- */
    async function doh(name, type) {
      const url = `https://cloudflare-dns.com/dns-query?name=${encodeURIComponent(name)}&type=${type}`;
      const res = await fetch(url, { headers: { accept:'application/dns-json' } });
      const res = await fetch(url, { headers:{ accept:'application/dns-json' } });
      if (!res.ok) return [];
      const data = await res.json();
      return (data.Answer || []).map(a => a.data);
    }

    (async function run() {
      const statusEl = document.getElementById('status');
      const statusEl  = document.getElementById('status');
      const detailsEl = document.getElementById('details');
      const msgs = [];

      try {
        // A record
        // A record (apex)
        const aAns = await doh(domain, 'A');
        const liveA = aAns.find(v => /^\d+\.\d+\.\d+\.\d+$/.test(v)) || 'N/A';
        document.getElementById('actA').textContent = liveA;

        // CNAME record
        // CNAME (host.domain)
        const cAns = await doh(`${cnameHost}.${domain}`, 'CNAME');
        const liveC = cAns.length ? cAns[0].replace(/\.$/, '').toLowerCase() : 'N/A';
        const liveC = cAns.length ? cAns[0].replace(/\.$/,'').toLowerCase() : 'N/A';
        document.getElementById('actC').textContent = liveC;

        // Compare
        const ok = (liveA === expectedA) &&
                   (liveC !== 'N/A' && liveC === expectedC.toLowerCase());
        statusEl.textContent = ok ? 'Your DNS Records are correct'
                                  : 'Your DNS Records are NOT correct';
        // Compare (CNAME case-insensitive)
        const cnameOK = (liveC !== 'N/A') && (liveC === expectedC.toLowerCase());
        const aOK     = (liveA === expectedA);

        if (!aOK) {
          document.getElementById('actA').classList.add('bad-text');
          msgs.push(`A record mismatch: expected ${expectedA}, actual ${liveA}`);
        }
        if (!cnameOK) {
          document.getElementById('actC').classList.add('bad-text');
          msgs.push(`CNAME mismatch (${cnameHost}.${domain}): expected ${expectedC}, actual ${liveC}`);
        }

        const ok = aOK && cnameOK;
        statusEl.textContent = ok ? 'Your DNS Records are correct' : 'Your DNS Records are NOT correct';
        statusEl.className = 'status ' + (ok ? 'ok' : 'bad');

        if (msgs.length) {
          detailsEl.innerHTML = msgs.map(m => m.replace(/&/g,'&amp;').replace(/</g,'&lt;')).join('<br>');
          detailsEl.classList.remove('hide');
        } else {
          detailsEl.classList.add('hide');
          detailsEl.textContent = '';
        }
      } catch (e) {
        statusEl.textContent = 'Error checking DNS';
        statusEl.className = 'status bad';
        detailsEl.classList.add('hide');
        detailsEl.textContent = '';
      }
    })();
  </script>    // Compare A
    let aMatch = expectedA.length ? expectedA.every(ip => liveA.includes(ip)) : null;
    addRow('A', expectedA.join(', ') || '-', liveA, aMatch);

    // Compare CNAME
    let cMatch = expectedC ? liveC.includes(canon(expectedC)) : null;

    // flatten case: if no CNAME returned, compare A(host) vs A(expectedC)
    if (expectedC && cMatch === false && liveC.length === 0) {
      const hostA = (await doh(fqdn,'A')).filter(v => /^\d+\.\d+\.\d+\.\d+$/.test(v));
      const expectedCA = (await doh(expectedC,'A')).filter(v => /^\d+\.\d+\.\d+\.\d+$/.test(v));
      if (hostA.length && expectedCA.length && expectedCA.every(ip => hostA.includes(ip))) {
        cMatch = true;
      }
    }
    addRow('CNAME', expectedC || '-', liveC, cMatch);

    // Overall banner
    const checks = [aMatch, cMatch].filter(v => v !== null);
    const ok = checks.length ? checks.every(Boolean) : false;
    banner.className = 'banner ' + (ok ? 'ok' : 'fail');
    banner.textContent = ok ? "YOUR DOMAIN'S DNS RECORDS ARE CORRECT" : "YOUR DOMAIN'S DNS RECORDS ARE NOT CORRECT";

    if (debug) console.log({domain, expectedA, expectedC, cnameHost, liveA, liveC, aMatch, cMatch, ok});
  } catch (e) {
    banner.className = 'banner fail';
    banner.textContent = 'Could not fetch DNS records';
    console.error(e);
  }
})();
</script>
</body>
</html>









